# SPDX-License-Identifier: AGPL-3.0-or-later
name: Echidna Smart Contract Fuzzing

permissions:
  contents: read
  checks: write
  pull-requests: write

on:
  push:
    branches: [main]
    paths:
      - 'contracts/**/*.sol'
      - 'echidna/**'
      - '.github/workflows/echidna-fuzz.yml'
  pull_request:
    paths:
      - 'contracts/**/*.sol'
      - 'echidna/**'
      - '.github/workflows/echidna-fuzz.yml'
  workflow_dispatch:
    inputs:
      contract:
        description: 'Contract to test (e.g., TokenEchidnaTest)'
        required: false
        default: ''
        type: string
      test_limit:
        description: 'Number of test iterations'
        required: false
        default: '10000'
        type: string
      test_mode:
        description: 'Echidna test mode'
        required: false
        default: 'property'
        type: choice
        options:
          - property
          - assertion
          - optimization
          - overflow
          - exploration

env:
  SOLC_VERSION: "0.8.19"
  ECHIDNA_VERSION: "2.2.3"

jobs:
  detect-contracts:
    name: Detect Solidity contracts
    runs-on: ubuntu-latest
    outputs:
      has_contracts: ${{ steps.detect.outputs.has_contracts }}
      has_echidna_tests: ${{ steps.detect.outputs.has_echidna_tests }}
      contracts: ${{ steps.detect.outputs.contracts }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Detect contract files
        id: detect
        run: |
          # Find all Solidity files
          contract_count=$(find contracts -name "*.sol" -type f 2>/dev/null | wc -l)

          # Find Echidna test contracts (contain "echidna_" functions)
          echidna_tests=$(grep -rl "echidna_" contracts/*.sol 2>/dev/null | xargs -I{} basename {} .sol | tr '\n' ',' | sed 's/,$//')

          echo "has_contracts=$([[ $contract_count -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_echidna_tests=$([[ -n "$echidna_tests" ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "contracts=$echidna_tests" >> $GITHUB_OUTPUT

          echo "::notice::Found $contract_count Solidity files, Echidna tests: $echidna_tests"

  echidna-property-test:
    name: Echidna Property Testing
    needs: detect-contracts
    if: needs.detect-contracts.outputs.has_echidna_tests == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        contract: ${{ fromJson(format('["{0}"]', needs.detect-contracts.outputs.contracts)) }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install solc
        run: |
          wget -q "https://github.com/ethereum/solidity/releases/download/v${{ env.SOLC_VERSION }}/solc-static-linux"
          chmod +x solc-static-linux
          sudo mv solc-static-linux /usr/local/bin/solc
          solc --version

      - name: Install Echidna
        run: |
          wget -q "https://github.com/crytic/echidna/releases/download/v${{ env.ECHIDNA_VERSION }}/echidna-${{ env.ECHIDNA_VERSION }}-x86_64-linux.tar.gz"
          tar -xzf "echidna-${{ env.ECHIDNA_VERSION }}-x86_64-linux.tar.gz"
          sudo mv echidna /usr/local/bin/
          echidna --version

      - name: Run Echidna property tests
        id: echidna
        run: |
          echo "::group::Echidna Property Testing - ${{ matrix.contract }}"

          CONTRACT_FILE="contracts/${{ matrix.contract }}.sol"
          CONFIG_FILE="echidna/echidna-ci.yaml"

          if [ ! -f "$CONTRACT_FILE" ]; then
            echo "::error::Contract file not found: $CONTRACT_FILE"
            exit 1
          fi

          mkdir -p echidna-results

          # Run Echidna with JSON output for CI
          set +e
          echidna "$CONTRACT_FILE" \
            --contract "${{ matrix.contract }}" \
            --config "$CONFIG_FILE" \
            --format json \
            2>&1 | tee echidna-results/property-test.json

          ECHIDNA_EXIT=$?
          set -e

          echo "::endgroup::"

          # Parse results
          if [ $ECHIDNA_EXIT -eq 0 ]; then
            echo "result=success" >> $GITHUB_OUTPUT
            echo "::notice::All property tests passed!"
          else
            echo "result=failure" >> $GITHUB_OUTPUT
            echo "::error::Echidna found property violations"
          fi

          exit $ECHIDNA_EXIT

      - name: Upload Echidna results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: echidna-property-results-${{ matrix.contract }}
          path: echidna-results/
          retention-days: 30

  echidna-assertion-test:
    name: Echidna Assertion Testing
    needs: detect-contracts
    if: needs.detect-contracts.outputs.has_echidna_tests == 'true'
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        contract: ${{ fromJson(format('["{0}"]', needs.detect-contracts.outputs.contracts)) }}
    steps:
      - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2

      - name: Install solc
        run: |
          wget -q "https://github.com/ethereum/solidity/releases/download/v${{ env.SOLC_VERSION }}/solc-static-linux"
          chmod +x solc-static-linux
          sudo mv solc-static-linux /usr/local/bin/solc

      - name: Install Echidna
        run: |
          wget -q "https://github.com/crytic/echidna/releases/download/v${{ env.ECHIDNA_VERSION }}/echidna-${{ env.ECHIDNA_VERSION }}-x86_64-linux.tar.gz"
          tar -xzf "echidna-${{ env.ECHIDNA_VERSION }}-x86_64-linux.tar.gz"
          sudo mv echidna /usr/local/bin/

      - name: Run Echidna assertion tests
        id: echidna
        run: |
          echo "::group::Echidna Assertion Testing - ${{ matrix.contract }}"

          CONTRACT_FILE="contracts/${{ matrix.contract }}.sol"
          CONFIG_FILE="echidna/echidna-assertion.yaml"

          mkdir -p echidna-results

          set +e
          echidna "$CONTRACT_FILE" \
            --contract "${{ matrix.contract }}" \
            --config "$CONFIG_FILE" \
            --format text \
            2>&1 | tee echidna-results/assertion-test.txt

          ECHIDNA_EXIT=$?
          set -e

          echo "::endgroup::"

          if [ $ECHIDNA_EXIT -eq 0 ]; then
            echo "::notice::All assertion tests passed!"
          else
            echo "::warning::Echidna found assertion violations"
          fi

      - name: Upload Echidna results
        if: always()
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: echidna-assertion-results-${{ matrix.contract }}
          path: echidna-results/
          retention-days: 30

  summary:
    name: Fuzzing Summary
    needs: [detect-contracts, echidna-property-test, echidna-assertion-test]
    if: always() && needs.detect-contracts.outputs.has_echidna_tests == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## ðŸ¦” Echidna Smart Contract Fuzzing Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Test Type | Contract | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Property Tests | ${{ needs.detect-contracts.outputs.contracts }} | ${{ needs.echidna-property-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Assertion Tests | ${{ needs.detect-contracts.outputs.contracts }} | ${{ needs.echidna-assertion-test.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- Solidity Version: ${{ env.SOLC_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- Echidna Version: ${{ env.ECHIDNA_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Fuzzed by [echidnabot](https://github.com/hyperpolymath/echidnabot)_" >> $GITHUB_STEP_SUMMARY
