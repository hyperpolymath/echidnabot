# SPDX-License-Identifier: PMPL-1.0-or-later
name: echidnabot Proof Verification

permissions:
  contents: read
  checks: write
  pull-requests: write

on:
  push:
    branches: [main]
    paths:
      - 'proofs/**'
      - 'specs/**'
      - '**/*.v'      # Coq
      - '**/*.lean'   # Lean
      - '**/*.agda'   # Agda
      - '**/*.lagda*' # Literate Agda
      - '**/*.smt2'   # SMT-LIB (Z3, CVC5)
      - '**/*.mm'     # Metamath
      - '**/*.thy'    # Isabelle
  pull_request:
    paths:
      - 'proofs/**'
      - 'specs/**'
      - '**/*.v'
      - '**/*.lean'
      - '**/*.agda'
      - '**/*.lagda*'
      - '**/*.smt2'
      - '**/*.mm'
      - '**/*.thy'
  workflow_dispatch:
    inputs:
      prover:
        description: 'Specific prover to use (or "all")'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - coq
          - lean4
          - agda
          - isabelle
          - z3
          - metamath

env:
  ECHIDNABOT_VERSION: "0.1.0"
  ECHIDNA_ENDPOINT: ${{ secrets.ECHIDNA_ENDPOINT || 'https://echidna.hyperpolymath.dev/graphql' }}

jobs:
  detect-proofs:
    name: Detect proof files
    runs-on: ubuntu-latest
    outputs:
      has_coq: ${{ steps.detect.outputs.has_coq }}
      has_lean: ${{ steps.detect.outputs.has_lean }}
      has_agda: ${{ steps.detect.outputs.has_agda }}
      has_isabelle: ${{ steps.detect.outputs.has_isabelle }}
      has_z3: ${{ steps.detect.outputs.has_z3 }}
      has_metamath: ${{ steps.detect.outputs.has_metamath }}
      any_proofs: ${{ steps.detect.outputs.any_proofs }}
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Detect proof file types
        id: detect
        run: |
          has_coq=$(find . -name "*.v" -type f | head -1 | wc -l)
          has_lean=$(find . -name "*.lean" -type f | head -1 | wc -l)
          has_agda=$(find . \( -name "*.agda" -o -name "*.lagda" -o -name "*.lagda.md" \) -type f | head -1 | wc -l)
          has_isabelle=$(find . -name "*.thy" -type f | head -1 | wc -l)
          has_z3=$(find . -name "*.smt2" -type f | head -1 | wc -l)
          has_metamath=$(find . -name "*.mm" -type f | head -1 | wc -l)

          echo "has_coq=$([[ $has_coq -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_lean=$([[ $has_lean -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_agda=$([[ $has_agda -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_isabelle=$([[ $has_isabelle -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_z3=$([[ $has_z3 -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT
          echo "has_metamath=$([[ $has_metamath -gt 0 ]] && echo true || echo false)" >> $GITHUB_OUTPUT

          any=$([[ $has_coq -gt 0 || $has_lean -gt 0 || $has_agda -gt 0 || $has_isabelle -gt 0 || $has_z3 -gt 0 || $has_metamath -gt 0 ]] && echo true || echo false)
          echo "any_proofs=$any" >> $GITHUB_OUTPUT

          echo "::notice::Detected: Coq=$has_coq, Lean=$has_lean, Agda=$has_agda, Isabelle=$has_isabelle, Z3=$has_z3, Metamath=$has_metamath"

  verify-coq:
    name: Verify Coq proofs
    needs: detect-proofs
    if: needs.detect-proofs.outputs.has_coq == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Coq
        run: |
          sudo apt-get update
          sudo apt-get install -y coq

      - name: Verify Coq files
        run: |
          echo "::group::Coq Verification"
          find . -name "*.v" -type f | while read -r file; do
            echo "Checking: $file"
            coqc "$file" 2>&1 || echo "::warning file=$file::Proof verification failed"
          done
          echo "::endgroup::"

  verify-lean:
    name: Verify Lean proofs
    needs: detect-proofs
    if: needs.detect-proofs.outputs.has_lean == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install elan (Lean version manager)
        run: |
          curl https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh -sSf | sh -s -- -y
          echo "$HOME/.elan/bin" >> $GITHUB_PATH

      - name: Verify Lean files
        run: |
          source "$HOME/.elan/env"
          echo "::group::Lean Verification"
          if [ -f lakefile.lean ] || [ -f lakefile.toml ]; then
            lake build 2>&1
          else
            find . -name "*.lean" -type f | while read -r file; do
              echo "Checking: $file"
              lean "$file" 2>&1 || echo "::warning file=$file::Proof verification failed"
            done
          fi
          echo "::endgroup::"

  verify-z3:
    name: Verify Z3/SMT proofs
    needs: detect-proofs
    if: needs.detect-proofs.outputs.has_z3 == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Z3
        run: |
          sudo apt-get update
          sudo apt-get install -y z3

      - name: Verify SMT files
        run: |
          echo "::group::Z3 Verification"
          find . -name "*.smt2" -type f | while read -r file; do
            echo "Checking: $file"
            z3 "$file" 2>&1 || echo "::warning file=$file::SMT verification failed"
          done
          echo "::endgroup::"

  verify-agda:
    name: Verify Agda proofs
    needs: detect-proofs
    if: needs.detect-proofs.outputs.has_agda == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1

      - name: Install Agda
        run: |
          sudo apt-get update
          sudo apt-get install -y agda

      - name: Verify Agda files
        run: |
          echo "::group::Agda Verification"
          find . \( -name "*.agda" -o -name "*.lagda" -o -name "*.lagda.md" \) -type f | while read -r file; do
            echo "Checking: $file"
            agda "$file" 2>&1 || echo "::warning file=$file::Proof verification failed"
          done
          echo "::endgroup::"

  summary:
    name: Verification Summary
    needs: [detect-proofs, verify-coq, verify-lean, verify-z3, verify-agda]
    if: always() && needs.detect-proofs.outputs.any_proofs == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Generate summary
        run: |
          echo "## echidnabot Proof Verification Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Prover | Detected | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|----------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| Coq | ${{ needs.detect-proofs.outputs.has_coq }} | ${{ needs.verify-coq.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Lean | ${{ needs.detect-proofs.outputs.has_lean }} | ${{ needs.verify-lean.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Agda | ${{ needs.detect-proofs.outputs.has_agda }} | ${{ needs.verify-agda.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Z3/SMT | ${{ needs.detect-proofs.outputs.has_z3 }} | ${{ needs.verify-z3.result || 'skipped' }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "_Verified by [echidnabot](https://github.com/hyperpolymath/echidnabot)_" >> $GITHUB_STEP_SUMMARY
